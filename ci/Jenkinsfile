ci_cpu = "metaprojdev/meta:ci_cpu-v0.14"
ci_gpu = "metaprojdev/meta:ci_gpu-v0.15"

docker_run = 'docker/bash.sh'
max_time = 120

mnm_multilib = "build/config.cmake, " +
               "build/lib/libtvm.so, " +
               "build/lib/libmnm.so"

mnm_multilib_cutlass = mnm_multilib + ", " +
                       "build/lib/libcutlass.so"

def init_git_unix() {
  checkout scm
  retry(5) {
    timeout(time: 2, unit: 'MINUTES') {
      sh 'git submodule update --init --recursive --force'
    }
  }
}

def init_git_win() {
  checkout scm
  retry(5) {
    timeout(time: 2, unit: 'MINUTES') {
      bat 'git submodule update --init --recursive --force'
    }
  }
}

def make(docker_type, path) {
  timeout(time: max_time, unit: 'MINUTES') {
    sh "${docker_run} ${docker_type} ./ci/task_clean.sh ${path}"
    sh "${docker_run} ${docker_type} ./ci/task_build.sh ${path} -j\$(nproc)"
    sh "${docker_run} ${docker_type} ./ci/task_cpp_unittest.sh"
  }
}

def pack_lib(name, libs) {
  sh """
     echo "Packing ${libs} into ${name}"
     echo ${libs} | sed -e 's/,/ /g' | xargs md5sum
     """
  stash includes: libs, name: name
}

def unpack_lib(name, libs) {
  unstash name
  sh """
     echo "Unpacked ${libs} from ${name}"
     echo ${libs} | sed -e 's/,/ /g' | xargs md5sum
     """
}

stage("Lint") {
  timeout(time: max_time, unit: 'MINUTES') {
    node('linux-cpu') {
      init_git_unix()
      sh "${docker_run} ${ci_cpu} ./ci/task_lint.sh"
    }
  }
}

stage('Build') {
  parallel 'BUILD: GPU': {
    node('linux-gpu') {
      init_git_unix()
      sh """
         mkdir -p build
         cd build
         cp ../cmake/config.cmake .
         echo "set(MNM_USE_LLVM llvm-config-8)" >> config.cmake
         echo "set(MNM_USE_GTEST ON)" >> config.cmake
         echo "set(MNM_USE_CUDA ON)" >> config.cmake
         echo "set(MNM_CUDA_ARCH 75)" >> config.cmake
         echo "set(MNM_USE_CUDNN ON)" >> config.cmake
         echo "set(MNM_USE_CUBLAS ON)" >> config.cmake
         echo "set(MNM_USE_MPI ON)" >> config.cmake
         echo "set(MNM_USE_NCCL ON)" >> config.cmake
         echo "set(MNM_USE_CUTLASS ON)" >> config.cmake
         echo "set(CMAKE_BUILD_TYPE Release)" >> config.cmake
         """
      make(ci_gpu, 'build')
      pack_lib('gpu', mnm_multilib_cutlass)
    }
  },
  'BUILD: CPU': {
    node('linux-cpu') {
      init_git_unix()
      sh """
         mkdir -p build
         cd build
         cp ../cmake/config.cmake .
         echo "set(MNM_USE_LLVM llvm-config-8)" >> config.cmake
         echo "set(MNM_USE_GTEST ON)" >> config.cmake
         echo "set(MNM_USE_CUDA OFF)" >> config.cmake
         echo "set(MNM_USE_CUDNN OFF)" >> config.cmake
         echo "set(MNM_USE_CUBLAS OFF)" >> config.cmake
         echo "set(CMAKE_BUILD_TYPE Release)" >> config.cmake
         """
      make(ci_cpu, 'build')
      pack_lib('cpu', mnm_multilib)
    }
  }
}

stage('Unit Test') {
  parallel 'python3: GPU': {
    node('linux-gpu') {
      init_git_unix()
      unpack_lib('gpu', mnm_multilib_cutlass)
      timeout(time: max_time, unit: 'MINUTES') {
        sh "${docker_run} ${ci_gpu} nvidia-smi -L"
        sh "${docker_run} ${ci_gpu} ./ci/task_python_unittest.sh"
      }
    }
  },
  'python3: CPU': {
    node('linux-cpu') {
      init_git_unix()
      unpack_lib('cpu', mnm_multilib)
      timeout(time: max_time, unit: 'MINUTES') {
        sh "${docker_run} ${ci_cpu} ./ci/task_python_unittest.sh"
      }
    }
  },
  'python3: multi-GPU': {
    node('linux-gpu-4x') {
      init_git_unix()
      unpack_lib('gpu', mnm_multilib_cutlass)
      timeout(time: max_time, unit: 'MINUTES') {
        sh "${docker_run} ${ci_gpu} nvidia-smi -L"
        sh "${docker_run} ${ci_gpu} ./ci/task_python_distributed.sh"
      }
    }
  }
}
